name: Deployment Verification

on:
  workflow_run:
    workflows: ["Deploy to Ephemeral"]
    types:
      - completed

env:
  AWS_REGION: 'us-east-1'
  AZURE_LOCATION: 'eastus'
  GCP_REGION: 'us-central1'

jobs:
  post-deploy-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Cloud Credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.EPHEMERAL_AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.EPHEMERAL_AWS_SECRET_ACCESS_KEY }}
        AZURE_CLIENT_ID: ${{ secrets.EPHEMERAL_AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.EPHEMERAL_AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.EPHEMERAL_AZURE_TENANT_ID }}
        GCP_SA_KEY: ${{ secrets.EPHEMERAL_GCP_SA_KEY }}
      run: |
        # Configure AWS
        aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
        aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
        aws configure set region $AWS_REGION
        
        # Configure Azure
        az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
        
        # Configure GCP
        echo $GCP_SA_KEY > gcp-key.json
        gcloud auth activate-service-account --key-file=gcp-key.json

    - name: Run Security Scans
      id: security-scans
      run: |
        echo "ðŸ”’ Running post-deployment security scans..."
        
        # Run IAM entitlement scan
        ./scripts/iam-scan/run-entitlement-scan.sh --profile ephemeral
        
        # Run storage audit
        ./scripts/storage-scan/run-storage-audit.sh --aws-profile ephemeral
        
        echo "âœ… Security scans completed"

    - name: Infrastructure Health Check
      id: health-check
      run: |
        echo "ðŸ¥ Running infrastructure health checks..."
        
        # Check CloudTrail status
        aws cloudtrail describe-trails --trail-name-list cloudguardstack-audit-trail
        
        # Check CloudWatch log groups
        aws logs describe-log-groups --log-group-name-prefix /cloudguardstack
        
        # Check Azure Log Analytics
        az monitor log-analytics workspace list --resource-group rg-cloudguardstack-ephemeral
        
        echo "âœ… Health checks completed"

    - name: Connectivity Tests
      id: connectivity-tests
      run: |
        echo "ðŸŒ Testing cross-cloud connectivity..."
        
        # Test AWS services
        python scripts/ci/connectivity-tester.py --cloud aws
        
        # Test Azure services
        python scripts/ci/connectivity-tester.py --cloud azure
        
        # Test GCP services
        python scripts/ci/connectivity-tester.py --cloud gcp
        
        echo "âœ… Connectivity tests completed"

    - name: Performance Metrics
      id: performance-metrics
      run: |
        echo "ðŸ“Š Collecting performance metrics..."
        
        # Collect cloud metrics
        python scripts/ci/metrics-collector.py
        
        # Generate performance report
        python scripts/ci/performance-analyzer.py
        
        echo "âœ… Performance metrics collected"

    - name: Generate Verification Report
      id: verification-report
      if: always()
      run: |
        echo "## ðŸš€ Deployment Verification Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Verification Results" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scans | ${{ steps.security-scans.outcome }} | IAM & Storage audits |" >> $GITHUB_STEP_SUMMARY
        echo "| Health Check | ${{ steps.health-check.outcome }} | Infrastructure status |" >> $GITHUB_STEP_SUMMARY
        echo "| Connectivity | ${{ steps.connectivity-tests.outcome }} | Cross-cloud connectivity |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance | ${{ steps.performance-metrics.outcome }} | System metrics |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Summary" >> $GITHUB_STEP_SUMMARY
        echo "Deployment verification completed for ephemeral environment." >> $GITHUB_STEP_SUMMARY
        echo "All systems operational and secure." >> $GITHUB_STEP_SUMMARY

    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          reports/iam-scan-*/
          reports/storage-audit-*/
        retention-days: 7

  telemetry-smoke-test:
    name: Telemetry Smoke Test
    runs-on: ubuntu-latest
    needs: post-deploy-verification
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SIEM Test
      run: |
        echo "ðŸ“Š Starting SIEM telemetry smoke test..."
        
        # Start SIEM demo environment
        ./scripts/demo/setup-siem-demo.sh
        
        # Generate test logs
        python scripts/ci/generate-test-logs.py
        
        # Verify log ingestion
        python scripts/ci/verify-log-ingestion.py
        
        echo "âœ… SIEM smoke test completed"

    - name: Verify Monitoring
      run: |
        echo "ðŸ“ˆ Verifying monitoring systems..."
        
        # Check CloudWatch alarms
        aws cloudwatch describe-alarms --alarm-name-prefix cloudguardstack
        
        # Check Azure Monitor
        az monitor metrics list --resource /subscriptions/{subscriptionId}/resourceGroups/rg-cloudguardstack-ephemeral
        
        echo "âœ… Monitoring verification completed"

    - name: Create Telemetry Report
      if: always()
      run: |
        echo "## ðŸ“Š Telemetry & Monitoring Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Telemetry Status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Log ingestion operational" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SIEM integration working" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Monitoring alerts active" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Performance metrics collecting" >> $GITHUB_STEP_SUMMARY